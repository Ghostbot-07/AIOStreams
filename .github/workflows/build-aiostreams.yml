name: Build AIOStreams (Frontend + Backend, no cache)

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "Release channel"
        required: false
        default: "stable"
        type: choice
        options:
          - stable
          - nightly

      version:
        description: "Git tag to build"
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Checkout & version resolution
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Fetch upstream tags
        run: git fetch https://github.com/viren070/aiostreams.git --tags

      - name: ğŸ·ï¸ Resolve version to build
        id: version
        run: |
          CHANNEL="${{ github.event.inputs.channel }}"
          INPUT_VERSION="${{ github.event.inputs.version }}"

          echo "Selected channel: $CHANNEL"

          if [ -n "$INPUT_VERSION" ]; then
            VERSION="$INPUT_VERSION"
            echo "Using user-specified version: $VERSION"
          else
            if [ "$CHANNEL" = "stable" ]; then
              VERSION=$(git tag --list \
                | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
                | sort -V \
                | tail -n 1)
            else
              VERSION=$(git tag --list \
                | grep -E 'nightly' \
                | sort -V \
                | tail -n 1)
            fi

            if [ -z "$VERSION" ]; then
              echo "âŒ No version found for channel: $CHANNEL"
              exit 1
            fi

            echo "Auto-selected version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ” Checkout selected version
        run: git checkout ${{ steps.version.outputs.version }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Tooling
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ“¦ Install dependencies
        run: pnpm install

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Build
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§± Build core
        run: pnpm --filter @aiostreams/core run build

      - name: âš™ï¸ Build server
        run: pnpm --filter @aiostreams/server run build

      - name: ğŸ¨ Build frontend (static export)
        run: pnpm --filter @aiostreams/frontend run build

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Metadata
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ·ï¸ Generate build metadata
        run: pnpm run metadata

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Artifact assembly (flat)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Prepare flat artifact directory
        run: |
          mkdir -p /tmp/artifact/packages/core
          mkdir -p /tmp/artifact/packages/server
          mkdir -p /tmp/artifact/packages/frontend
          mkdir -p /tmp/artifact/resources

          cp -r packages/core/dist /tmp/artifact/packages/core/
          cp -r packages/server/dist /tmp/artifact/packages/server/
          cp -r packages/frontend/out /tmp/artifact/packages/frontend/
          cp resources/metadata.json /tmp/artifact/resources/

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Create REAL release zip (you care about this)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦ Create release zip (aiostreams-vX.Y.Z.zip)
        run: |
          cd /tmp/artifact
          zip -r ../aiostreams-${{ steps.version.outputs.version }}.zip packages resources

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Upload as generic artifact (transport only)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â¬†ï¸ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: artifact
          path: /tmp/aiostreams-${{ steps.version.outputs.version }}.zip
          retention-days: 1
